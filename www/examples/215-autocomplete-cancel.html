id: cancelling-autocomplete
title: Cancelling Autocomplete
tags: ts-req-strategy, usecase
----
<p>When autocomplete triggers a time-consuming operation (e.g. full-text search),
  the implementation above triggers numerous requests if the user types slow enough.
  If requests finish at different durations, an older request can override the
  latest. To avoid this, we need to abort the XHR using <code>ts-req-strategy="last"</code>.</p>

<div class="card example">
  <div class="card-header">
    <h5 class="d-inline mr-2">Demo</h5>
    <button class="btn btn-link btn-sm reset">Reset</button>
    <button class="btn btn-link btn-sm source">View Source</button>
  </div>

  <div class="card-body">
    <p>Every other request is slow</p>
    <p><input type="text"
              name="q"
              ts-req-strategy="last"
              ts-req="/cancelling-autocomplete"
              ts-trigger="keyup changed delay 100"
              ts-target="#search-results-2"
              ts-swap="inner"
              placeholder="Search..."/></p>
    <div id="search-results-2"></div>
  </div>

  <script>
    function delay(mock, ms) {
      return (req, res) =>
        Promise.resolve(mock(req, res)).then(val => {
          return new Promise(resolve => {
            const after = ms();
            console.debug('âŒ› Delaying', Math.round(after, 2)/1000., 'sec');
            return setTimeout(() => resolve(val), after, true);
          });
        });
    };

    var counter = 0;

    XHRMock.get(/\/cancelling-autocomplete/, delay(function(req, res) {
      var q = ('Query ' + (counter+1)
               + ' (' + (counter % 2 === 0 ? 'fast' : 'slow') + '): '
               + req.url().query.q);
      var now = +new Date;
      return res.status(200).body('<div>' +
                      ('one two three four five six seven'
                        .split(' ')
                        .map(s => '<p>' + q + ' ' + s + ' ' + now + '</p>')
                        .join('')) +
                      '</div>');
    }, () => 500 + (counter++ % 2) * 2000));
  </script>
</div>
