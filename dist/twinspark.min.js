(function(p,q,va){function C(a,b){return ca&&ca.dataset[a]||b}function D(){var a=[].reduce.call(arguments,(b,c)=>{if(b[c.length])throw w("Arity dispatch: duplicate function with the same number of arguments",{length:c.length,func:c.length,duplicate:b[c.length]});b[c.length]=c;return b},{});return function(){var b=arguments.length,c=a[b];if(!c)throw w("No function supplied accepting "+b+" arguments",{functions:a,arguments:Array.from(arguments)});return c.apply(this,arguments)}}function wa(a,b){return a.reduce(function(c,
d){var e=b(d);(c[e]||(c[e]=[])).push(d);return c},{})}function xa(a,b){return a.map((c,d)=>[c,b[d]])}function ya(a){for(var b=new Set,c=[],d,e=0;e<a.length;e++)d=a[e],b.has(d)||(b.add(d),c.push(d));return c}function w(a,b){a=Error(a);a.extra=b;return a}function J(a){var b=null;return function(){return b||(b=a())}}function da(a){if(a=a&&a.trim())return a.match(/\d+s/)?1E3*parseFloat(a):parseFloat(a)}function ea(a){"loading"==q.readyState?q.addEventListener("DOMContentLoaded",a):a()}function t(a,b,
c,d){d=d&&d.hasOwnProperty("bubbles")?d.bubbles:!0;d=new CustomEvent(b,{bubbles:d,cancelable:!0,detail:c});console.debug("\ud83d\udece\ufe0f EVENT",b,{el:a,detail:c});a.dispatchEvent(d);return d}function z(a,b){return 1==a.nodeType&&a.matches(b)?a:a.querySelector?a.querySelector(b):null}function E(a,b){if(!a.querySelectorAll)return[];var c=Array.from(a.querySelectorAll(b));1==a.nodeType&&a.matches(b)&&c.unshift(a);return c}function fa(a){if(a.id)return a.id;var b=a.tagName.toLowerCase();return a.className?
b+"."+a.className.replace(" ","."):b}function ha(a,b){var c=[],d=a;do(a=d.getAttribute(b))&&c.push(a);while(d=d.parentElement);return c}function x(a,b,c){a=a["twinspark-internal"]||(a["twinspark-internal"]={});if(!b)return a;a.hasOwnProperty(b)||"undefined"==typeof c||(a[b]=c);return a[b]}function F(a,b){a={selector:a,handler:b};K.push(a);T&&E(q.body,a.selector).forEach(a.handler)}function za(a){x(a,"event-handlers",[]).forEach(b=>a.removeEventListener(b.type,b.func,b.opts))}function u(a,b,c,d){a.addEventListener(b,
c,d);x(a,"event-handlers",[]).push({type:b,func:c,opts:d});return a}function Aa(a){za(a);K.forEach(b=>a.matches(b.selector)&&b.handler(a))}function L(a){var b=K.map(c=>c.selector).join(",");E(q.body,b).forEach(Aa);t(a,"ts-ready")}function Ba(a,b){var c=new XMLHttpRequest;return{promise:new Promise(function(d,e){b||(b={});c.open(b.method||"GET",a,!0);for(var f in b.headers)c.setRequestHeader(f,b.headers[f]);c.onreadystatechange=function(){if(4==c.readyState&&0!=c.status){var h={"ts-title":c.getResponseHeader("ts-title"),
"ts-history":c.getResponseHeader("ts-history"),"ts-swap":c.getResponseHeader("ts-swap"),"ts-swap-push":c.getResponseHeader("ts-swap-push")};return d({ok:200<=c.status&&299>=c.status,status:c.status,url:c.responseURL,reqUrl:a,xhr:c,opts:b,headers:h,content:c.responseText})}};c.timeout=Ca;c.ontimeout=function(){return e({ok:!1,status:0,url:a,error:"timeout"})};c.send(b.body)}),xhr:c}}function G(a,b,c){if(!b)return a;var d,e;for([d,e]of b)d&&(!c||null!==e&&""!==e?a.append(d,e):a.delete(d));return a}
function Da(a,b){return ha(a,b).reduceRight((c,d)=>{if(""==d)var e=null;else if("{"==d[0])if(d=JSON.parse(d),"object"===typeof d&&null!==d){var f=[];for(e in d)f.push([e,d[e]]);e=f}else e=void 0;else e=G(new FormData,new URLSearchParams(d));return G(c,e,!0)},new FormData)}function U(a){return a.name&&("submit"!=a.type||a.hasAttribute("ts-clicked"))&&("radio"!=a.type&&"checkbox"!=a.type||a.checked)?a.value:null}function ia(a,b){var c=Da(a,"ts-data"),d=a.tagName,e;"FORM"==d?(c=G(c,new FormData(a)),
d=q.activeElement,"submit"==d.type&&d.name&&d.value&&!c.has(d.name)?c.append(d.name,d.value):"submit"==(null==b?void 0:b.type)&&(a=z(a,"[type=submit]"))&&a.name&&a.value&&!c.has(a.name)&&c.append(a.name,a.value)):("INPUT"==d||"SELECT"==d||"TEXTAREA"==d)&&(e=U(a))&&c.append(a.name,e);return c}function M(a){return new Promise(function(b,c){a.onsuccess=function(){b(a.result)};a.onerror=function(){c(a.error)}})}function ja(){if(V)return V;var a=Ea.open("twinspark",1);a.onupgradeneeded=function(){a.result.createObjectStore("twinspark",
{keyPath:"url"}).createIndex("time","time")};return V=M(a)}function N(a,b){return a.transaction(a.name,b&&b.write&&"readwrite"||"readonly").objectStore(a.name)}async function Fa(a){var b=N(a);b=await M(b.count());console.debug("PAGES IN STORAGE",b);var c=b-Ga;if(!(0>=c)){b=N(a,{write:!0});var d=b.index("time").openCursor();d.onsuccess=function(e){if(e=d.result)e.delete(),0<--c&&e.continue()}}}async function ka(){var a={url:A.pathname+A.search,html:q.body.innerHTML,time:+new Date},b=await ja(),c=N(b,
{write:!0});await M(c.put(a));await Fa(b)}function Ha(a,b){ka();history.replaceState("history","","");history.pushState(null,b,a);t(p,"ts-pushstate",{url:a})}function Ia(a){history.replaceState("history","",a);t(p,"ts-replacestate",{url:a})}async function la(a){if(a.state){var b=A.pathname+A.search,c=await ja();c=N(c);b=await M(c.get(b));console.debug("onpopstate restore",b.url,b.html.length,b.time);b&&b.html&&(q.body.innerHTML=b.html,("INITIAL"!=a.state||T)&&L(q.body))}}function y(a,b){if(!a)return a;
null==b&&(b=a.getAttribute("ts-target"));return b?b.split("|").map(c=>c.trim()).reduce((c,d,e)=>{e=0<e;if(d&&c&&"target"!=d)if("inherit"==d){var f=c.parentElement.closest("[ts-target]");f=y(f)}else f="parent "==d.slice(0,7)?c.closest(d.slice(7)):"child "==d.slice(0,6)?c.querySelector(d.slice(6)):"sibling "==d.slice(0,8)?c.parentElement.querySelector(d.slice(8)):e?c.querySelector(d):q.querySelector(d);else f=c;if(!f)throw c=c.outerHTML.match(/<.+?>/)[0],w(`Could not find element with selector ${d} for element ${c}`+
(e?" among children":""),{element:c,selector:d});return f},a):a}function ma(a,b){for(var c of Ja){var d=a,e=c,f=b.getAttribute(e);f!=d.getAttribute(e)&&(f?d.setAttribute(e,f):d.removeAttribute(e))}}function Ka(a){a.classList.add(na);setTimeout(()=>a.classList.remove(na))}function La(a,b,c){if(a.id){b=b.querySelector(a.tagName+"[id='"+a.id+"']");if(!b)return Ka(a);var d=a.cloneNode();ma(a,b);c.tasks.push(function(){ma(a,d)});return c}}function W(a,b,c,d){a||(a="replace");"morph"!=a&&"morph-all"!=a&&
"skip"!=a&&E(c,"[id]").forEach(function(e){La(e,b,d)});switch(a){case "replace":b.replaceWith(c);break;case "inner":b.replaceChildren(c);break;case "prepend":b.prepend(c);break;case "append":b.append(c);break;case "beforebegin":b.parentNode.insertBefore(c,b);break;case "afterend":b.parentNode.insertBefore(c,b.nextSibling);break;case "skip":break;default:throw Error("Unknown swap strategy "+a);}return c}function oa(a,b,c){var d=y(a);if(!d)throw w(`Target element not found for origin ${a.outerHTML.match(/<.+?>/)[0]}`,
{origin:a,replyParent:b});var e;if(e=a.getAttribute("ts-req-selector"))if("children "==e.slice(0,9)){e=z(b,e.slice(9));var f=new DocumentFragment;e&&e.children&&f.append.apply(f,e.children);e=f}else e=z(b,e);else e="BODY"==b.tagName&&"BODY"!=d.tagName?b.children[0]:b;if(!e)throw c=a.getAttribute("ts-req-selector"),w("Cannot find specified html in response, "+`maybe nothing to select as ${c}`,{sel:c,replyParent:b,origin:a});b=a.getAttribute("ts-swap");if(a){f={response:c.response};var h=t(a,"ts-req-after",
f);O(a,h,a.getAttribute("ts-req-after"),f)}return W(b,d,e,c)}function Ma(a,b,c){var d={response:c,tasks:[]},e,f;"skip"!=c.headers["ts-swap"]&&(e=1==a.length?[oa(a[0],b,d)]:xa(a,b.children).map(([h,l])=>oa(h,l,d)));a=E(b,"[ts-swap-push]").map(h=>{try{var l=h.getAttribute("ts-swap-push");!l&&h.id&&(l="#"+h.id);var m=z(q.body,l);if(!m)throw w("cannot find target for server-pushed swap",{reply:h});var g=h.getAttribute("ts-swap");return W(g,m,h,d)}catch(k){console.error(k)}});c.headers["ts-swap-push"]&&
(f=c.headers["ts-swap-push"].split(",").map(h=>{try{var l=h.match(/(\w+):(.+)<=(.+)/);if(!l)throw w("Cannot parse ts-swap-push header value",{header:h});var m=l[1],g=z(q.body,l[2]);if(!g)throw w("cannot find target for header swap",{sel:l[2]});var k=z(b,l[3]);if(!k)throw w("cannot find target for header swap",{reply:k,sel:l[3]});return W(m,g,k,d)}catch(n){console.error(n)}}));e=e.concat(a).concat(f).filter(h=>h);e=ya(e);e.forEach(function(h){for(var l=h.querySelectorAll("script"),m=0;m<l.length;m++){var g=
l[m];if(!(g.type&&"text/javascript"!=g.type||g.dataset.tsNoload)){for(var k=g.parentNode,n=q.createElement(g.nodeName),r=0;r<g.attributes.length;r++){var v=g.attributes[r].name,P=g.getAttribute(v);n.setAttribute(v,P)}n.appendChild(q.createTextNode(g.innerHTML));k.replaceChild(n,g)}}L(h);(h=z(h,"[autofocus]"))&&h.focus()});setTimeout(function(){d.tasks.forEach(function(h){h()})},16);return e}function pa(a,b,c,d){var e=(new DOMParser).parseFromString(c,"text/html");e.body.querySelectorAll("noscript").forEach(f=>
f.remove());c=d.headers["ts-title"]||e.title;e=e.body;if(e.children.length<b.length)throw`This request needs at least ${b.length} elements, `+`but ${e.children.length} were returned`;(a=d.headers["ts-history"]||b[0].hasAttribute("ts-req-history")&&a)&&("replace"==b[0].getAttribute("ts-req-history")?Ia(a):Ha(a,c));return Ma(b,e,d)}function Na(a){let b,c,d;var e=ia(a.el,null!=(d=null==(b=a.event)?void 0:null==(c=b.detail)?void 0:c.event)?d:a.event);return{method:a.method,data:e,headers:{Accept:"text/html+partial",
"TS-URL":A.pathname+A.search,"TS-Origin":fa(a.el),"TS-Target":fa(y(a.el))}}}function Oa(a,b){if(!b)return a;if(!Array.from(b.entries).every(c=>"string"===typeof c))return a.body=b,a;b=new URLSearchParams(b);a.body=b.toString();a.headers["Content-Type"]="application/x-www-form-urlencoded";return a}function Pa(a){if(a.length){var b=a[0].url,c=a[0].method,d=a.reduce(function(g,k){return G(g,k.opts.data)},new FormData),e="GET"==c?(new URLSearchParams(d)).toString():null;d="GET"!=c?d:null;var f={method:c,
headers:a.reduce(function(g,k){k=k.opts.headers;for(var n in k)g[n]?g[n]!=k[n]&&(g[n]+=", "+k[n]):g[n]=k[n];return g},{})};f=Oa(f,d);var h=b;e&&(h+=-1==b.indexOf("?")?"?":"&",h+=e);var l=a.map(function(g){return g.el}),m=Ba(h,f);l.forEach(function(g){g.setAttribute("aria-busy","true");g.classList.add(Qa);x(g)["active-xhr"]=m.xhr});return m.promise.then(function(g){Q(()=>l.forEach(k=>{k.removeAttribute("aria-busy");k.classList.remove("ts-active");delete x(k)["active-xhr"]}));if(m.xhr.isAborted)return!1;
if(g.ok)return g.url&&g.url!=(new URL(h,A.href)).href?(g.headers["ts-history"]||(g.headers["ts-history"]=g.url),g.swap=pa(g.url,[q.body],g.content,g)):g.swap=pa(b,l,g.content,g),g;R("Something wrong with response",g.content);l.forEach(function(k){t(k,"ts-req-error",B({error:"ts-req-error"},{response:g,url:h,opts:f}))});return g}).catch(function(g){Q(()=>l.forEach(k=>{k.removeAttribute("aria-busy");k.classList.remove("ts-active");delete x(k)["active-xhr"]}));R("Error retrieving backend response",h,
g.error||g);l.forEach(function(k){t(k,"ts-req-error",B({error:"ts-req-error"},{response:g,url:h,opts:f}))});return g})}}function X(a){a=Array.isArray(a)?a:[a];return Promise.all(a.map(function(b){b.opts=Na(b);var c={req:b},d=t(b.el,"ts-req-before",c);if(d.defaultPrevented)return null;var e=b;(c=O(b.el,d,b.el.getAttribute("ts-req-before"),c))&&(e=c.then(function(h){return d.defaultPrevented?null:b}));c=b.el.getAttribute("ts-req-strategy")||"queue";var f=x(b.el)["active-xhr"];if("first"===c&&f)return null;
"last"===c&&f&&(f.abort(),delete x(b.el)["active-xhr"]);return e})).then(function(b){return b.filter(function(c){return!!c})}).then(Pa)}function Ra(){var a=wa(H.reqs,c=>c.method+c.url);H={reqs:[],request:null};for(var b in a)X(a[b])}function Y(a,b,c){var d=(c?a.getAttribute("ts-req-batch"):a.getAttribute("ts-req"))||("FORM"==a.tagName?a.getAttribute("action"):a.getAttribute("href")),e=(a.getAttribute("ts-req-method")||("FORM"==a.tagName?a.getAttribute("method")||"POST":"GET")).toUpperCase();return{el:a,
opts:{},event:b,url:d,method:e,batch:c}}function Sa(a){u(a,"click",function(b){b.target.focus();a.setAttribute("ts-clicked","1");Q(function(){a.removeAttribute("ts-clicked")})})}function Z(a,b){var c=a.tagName,d="click";if("FORM"==c)d="submit";else if("INPUT"==c||"SELECT"==c||"TEXTAREA"==c)d="change";"FORM"==c&&"submit"==d&&E(a,'button, input[type="submit"]').forEach(Sa);return u(a,d,function(e){e.altKey||e.ctrlKey||e.shiftKey||e.metaKey||0!=(e.button||0)||(e.preventDefault(),e.stopPropagation(),
b(e))})}function aa(a,b,c){a=p._ts_func&&p._ts_func[a]||I[a]||p[a];if(!a)throw Error("Unknown action command: "+c.src);return a.apply(c.el,b.concat([c]))}function ba(a){function b(){var v=l.trim();if(v.length){var P=h,Ta=P.push;var qa=v[0];v='"'==qa||"'"==qa?v.slice(1,v.length-1):v;Ta.call(P,v)}l=""}function c(){h.length&&(f.push({src:a.slice(m,k).trim(),name:h[0],args:h.slice(1)}),h=[],m=k+1)}function d(){f.length&&(e.push({src:a.slice(g,k).trim(),commands:f}),f=[],g=k+1)}var e=[],f=[],h=[],l="",
m=0,g=0,k=0,n=null;for(k=0;k<a.length;k++){var r=a[k];if(n)"\\"==r?(k++,l+=a[k]):r==n?(l+=r,n=null):l+=r;else{if("'"==r||'"'==r)n=r;else if(" "==r){b();continue}else if(","==r){b();c();continue}else if(";"==r){b();c();d();continue}l+=r}}b();c();d();return e}function Ua(a,b){console.debug("ACTION",a.src,b);var c=B({line:a.src},b);return a.commands.reduce(function(d,e){return d.then(function(f){console.debug(!1!==f?"\ud83d\udd35":"\ud83d\udeab","COMMAND",e.src,{input:f,src:a.src});if(!1===f)return f;
void 0!==f&&(c.input=f);c.command=e.name;c.src=e.src;return aa(e.name,e.args,c)}).catch(function(f){throw B(f,{extra:{command:e.src,action:a.src,element:c.el.outerHTML.match(/<.+?>/)[0]}});})},Promise.resolve(null))}function O(a,b,c,d){if(c){console.debug("ACTIONS",{spec:c,event:b,payload:d});c=ba(c);a=B({el:a,event:b},d);var e;for(b=0;b<c.length;b++)d=c[b],d.commands.length&&(e=Ua(d,a));return e}}function ra(a){var b=a.on,c=a.off,d=a.threshold;return new IntersectionObserver(function(e,f){for(f=
0;f<e.length;f++){var h=e[f];h.intersectionRatio>d?t(h.target,b,{entry:h}):h.intersectionRatio<d&&t(h.target,c,{entry:h})}},a)}function Va(a){var b=a.args.indexOf("delay"),c=-1!=a.args.indexOf("changed"),d=-1!=a.args.indexOf("once"),e=-1!=b?da(a.args[b+1]):null;return function(f,h){function l(){t(f,"ts-trigger",{event:h},{bubbles:!1})}var m=x(f,"trigger",{});if(d){if(m.once)return;m.once=!0}if(c){if(m.value==U(f))return;m.value=U(f)}e?(m.delay&&clearTimeout(m.delay),m.delay=setTimeout(l,e)):l()}}
function S(a,b,c,d){function e(f){c(f);x(a,"trigger",{}).once&&a.removeEventListener(b,e,d)}u(a,b,e,d)}function Wa(a,b){var c=b.name,d=Va(b);switch(c){case "load":Q(function(){d(a,{type:"load"})});break;case "windowScroll":S(p,"scroll",function(e){d(a,e)},{passive:!0});break;case "scroll":S(a,"scroll",function(e){d(a,e)},{passive:!0});break;case "outside":S(q,"click",function(e){a.contains(e.target)||d(a,e)},{capture:!0});break;case "remove":Xa().observe(a.parentElement,{childList:!0});u(a,c,function(e){d(a,
e)});break;case "empty":case "notempty":case "childrenChange":Ya().observe(a,{childList:!0});u(a,c,function(e){d(a,e)});break;case "visible":case "invisible":Za().observe(a);u(a,c,function(e){d(a,e)});break;case "closeby":case "away":$a().observe(a);u(a,c,function(e){d(a,e)});break;default:S(a,c,function(e){d(a,e)})}}function sa(a){p.addEventListener("popstate",la);p.addEventListener("beforeunload",ka);L(q.body);T=!0;console.debug("init done",a)}var A=p.location,ca=q.currentScript,Ca=parseInt(C("timeout",
3E3),10),Ga=parseInt(C("history",20),10),Ja=C("settle","class,style,width,height").split(","),na=C("insert-class","ts-insert");C("remove-class","ts-remove");var Qa=C("active-class","ts-active"),T=!1,K=[],I={stop:function(a){a.event&&a.event.stopPropagation()},prevent:function(a){a.event&&a.event.preventDefault()},delay:function(a){return new Promise(function(b){setTimeout(b,da(a),!0)})},not:function(a){var b=[].slice.call(arguments,1,arguments.length-1),c=B({},arguments[arguments.length-1]);c.src=
c.src.slice(c.command.length+1);b=aa(a,b,c);return null===b||void 0===b?b:!b},target:function(a,b){try{return b.el=y(b.el,a),b.el}catch(c){return!1}},remove:D(function(a){a.el.remove()},function(a,b){y(b.el,a).remove()}),wait:function(a,b){return new Promise(function(c){u(b.el,a,c,{once:!0})})},class:function(a,b){b.el.classList.add(a)},"class+":function(a,b){b.el.classList.add(a)},"class-":function(a,b){b.el.classList.remove(a)},"class^":function(a,b){b.el.classList.toggle(a)},classtoggle:function(a,
b){b.el.classList.toggle(a)},text:D(function(a){return a.el.innerText=a.input},function(a,b){return b.el.innerText=a}),html:D(function(a){return a.el.innerHTML=a.input},function(a,b){return b.el.innerHTML=a}),attr:D(function(a,b){let c=b.el[a];return"undefined"!=typeof c?c:b.el.getAttribute(a)},function(a,b,c){c.el[a]=b;c.el.setAttribute(a,b);return b}),log:function(){var a=arguments;var b=a.length;var c=[].slice.call(a,0,b-1);a=a[b-1];a.input&&c.push(a.input);console.log.apply(console,c)}},R=console.error?
console.error.bind(console,"TwinSpark error:"):console.log.bind(console,"TwinSpark error:"),B=Object.assign||function(a,b){if(!b)return a;for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c]);return a},Q=p.requestIdleCallback||function(a){setTimeout(a,100)},Ea=p.indexedDB||p.mozIndexedDB||p.webkitIndexedDB||p.msIndexedDB,V,H={reqs:[],request:null};F("[ts-req]",function(a){function b(c){X([Y(a,c,!1)])}a.hasAttribute("ts-trigger")?u(a,"ts-trigger",b):Z(a,b)});F("[ts-req-batch]",function(a){function b(c){c=
Y(a,c,!0);H.reqs.push(c);H.request||(H.request=setTimeout(Ra,16))}a.hasAttribute("ts-trigger")?u(a,"ts-trigger",b):Z(a,b)});F("[ts-action]",function(a){var b=function(c){c.detail&&c.detail.event&&(c=c.detail.event);O(y(a),c,a.getAttribute("ts-action"),null)};a.hasAttribute("ts-trigger")?u(a,"ts-trigger",b):"A"==a.tagName||"BUTTON"==a.tagName?Z(a,b):R("No trigger for action on element",a)});var Za=J(function(){return ra({on:"visible",off:"invisible",rootMargin:"0px",threshold:.01})}),$a=J(function(){return ra({on:"closeby",
off:"away",rootMargin:(p.innerHeight/2|0)+"px",threshold:.01})}),Xa=J(function(){return new MutationObserver(function(a){for(var b=0;b<a.length;b++)for(var c=a[b],d=0;d<c.removedNodes.length;d++)t(c.removedNodes[d],"remove",{record:c})})}),Ya=J(function(){return new MutationObserver(function(a){for(var b=0;b<a.length;b++){var c=a[b];"childList"==c.type&&(t(c.target,c.target.childNodes.count?"notempty":"empty",{record:c}),t(c.target,"childrenChange",{record:c}))}})});F("[ts-trigger]",function(a){var b=
a.getAttribute("ts-trigger");b&&ba(b)[0].commands.forEach(function(c){Wa(a,c)})});ea(sa);let ta,ua;(null==(ta=p.performance)?void 0:null==(ua=ta.navigation)?void 0:ua.type)==p.performance.navigation.TYPE_BACK_FORWARD&&la({state:"INITIAL"});p[va]={onload:ea,register:F,activate:L,func:function(a,b){if("object"==typeof a)return B(I,a);b&&(I[a]=b);return I},elcrumbs:ha,arity:D,data:ia,merge:G,target:y,query:y,trigger:t,parseAction:ba,action:O,exec:aa,makeReq:Y,executeReqs:X,morph,setERR:a=>R=a,_internal:{DIRECTIVES:K,
FUNCS:I,init:sa}}})(window,document,"twinspark");
